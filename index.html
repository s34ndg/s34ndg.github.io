<!DOCTYPE html>
<html>
<head>
    <title>Web Audio App</title>
    <style>
        /* Add CSS styles to customize the UI */
    </style>
</head>
<body>
<h1>Web Audio App</h1>
<button id="startButton">Start</button>
<p id="statusText">Not listening</p>
<label for="silenceDuration">Silence Duration (in seconds):</label>
<input type="number" id="silenceDuration" min="1" value="5">
<p id="ambientNoiseLevel">Ambient Noise Level: <span id="noiseLevelValue">-</span> dB</p>
<label for="audioThresholdInput">Audio Threshold:</label>
<input type="number" id="audioThresholdInput" min="-100" max="0" step="1">
<button id="calibrationButton">Calibrate</button>

<script>
        // Check for browser compatibility
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Web Audio API is not supported in this browser.');
        }

        // Get references to UI elements
        const startButton = document.getElementById('startButton');
        const statusText = document.getElementById('statusText');
        const silenceDurationInput = document.getElementById('silenceDuration');
        const ambientNoiseLevelText = document.getElementById('ambientNoiseLevel');
        const noiseLevelValueText = document.getElementById('noiseLevelValue');
        const calibrationButton = document.getElementById('calibrationButton');
        const audioThresholdInput = document.getElementById('audioThresholdInput');

        let isListening = false;
        let audioContext = null;
        let audioStream = null;
        let audioSource = null;
        let audioProcessor = null;
        let audioThreshold = -60; // Default threshold, can be overridden by user input or ambient noise level
        let silenceDuration = parseInt(silenceDurationInput.value, 10);
        let ambientNoiseLevel = 0;
        let timeoutId = null;

        startButton.addEventListener('click', toggleListening);
        silenceDurationInput.addEventListener('input', updateSilenceDuration);
        calibrationButton.addEventListener('click', calibrate);
        audioThresholdInput.addEventListener('input', updateAudioThreshold);

        function toggleListening() {
            if (!isListening) {
                requestAudioPermission();
            } else {
                stopListening();
            }
        }

        function requestAudioPermission() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(startListening)
                .catch(handleAudioPermissionError);
        }

        function handleAudioPermissionError(error) {
            console.error('Audio permission denied:', error);
            statusText.textContent = 'Permission denied. Please allow access to the microphone.';
        }

        function startListening(stream) {
            isListening = true;
            startButton.textContent = 'Stop';
            statusText.textContent = 'Listening...';

            audioContext = new AudioContext();
            audioStream = stream;
            audioSource = audioContext.createMediaStreamSource(audioStream);
            audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);

            audioProcessor.onaudioprocess = processAudio;

            audioSource.connect(audioProcessor);
            audioProcessor.connect(audioContext.destination);
        }

        function stopListening() {
            isListening = false;
            startButton.textContent = 'Start';
            statusText.textContent = 'Not listening';

            audioProcessor.onaudioprocess = null;

            audioSource.disconnect();
            audioProcessor.disconnect();
            audioStream.getTracks().forEach(track => track.stop());
        }

        function processAudio(event) {
            const input = event.inputBuffer.getChannelData(0);
            let sum = 0;

            for (let i = 0; i < input.length; i++) {
                sum += input[i] * input[i];
            }

            const rms = Math.sqrt(sum / input.length);
            const decibel = 20 * Math.log10(rms);

            if (decibel < audioThreshold) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(showNotification, silenceDuration * 1000);
            }
        }

        function showNotification() {
            if (Notification.permission === 'granted') {
                new Notification('No audio detected', 'Please check your microphone or surroundings.');
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission()
                    .then(permission => {
                        if (permission === 'granted') {
                            new Notification('No audio detected', 'Please check your microphone or surroundings.');
                        }
                    });
            }
        }

        function updateSilenceDuration() {
            silenceDuration = parseInt(silenceDurationInput.value, 10);
        }

        function updateAudioThreshold() {
            audioThreshold = parseInt(audioThresholdInput.value, 10);
        }

        function calibrate() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(startCalibration)
                .catch(handleAudioPermissionError);
        }

        function startCalibration(stream) {
            const calibrationContext = new AudioContext();
            const calibrationSource = calibrationContext.createMediaStreamSource(stream);
            const calibrationProcessor = calibrationContext.createScriptProcessor(4096, 1, 1);
            const calibrationBuffer = [];

            calibrationProcessor.onaudioprocess = event => {
                const input = event.inputBuffer.getChannelData(0);

                for (let i = 0; i < input.length; i++) {
                    calibrationBuffer.push(input[i]);
                }
            };

            calibrationSource.connect(calibrationProcessor);
            calibrationProcessor.connect(calibrationContext.destination);

            setTimeout(() => {
                calibrationProcessor.onaudioprocess = null;
                calibrationSource.disconnect();
                calibrationProcessor.disconnect();
                stream.getTracks().forEach(track => track.stop());

                const rms = calculateRMS(calibrationBuffer);
                const decibel = 20 * Math.log10(rms);
                ambientNoiseLevel = decibel.toFixed(2);
                noiseLevelValueText.textContent = ambientNoiseLevel;

                // Update audio threshold based on ambient noise level
                audioThreshold = ambientNoiseLevel;
                audioThresholdInput.value = ambientNoiseLevel;
            }, 5000);
        }

        function calculateRMS(buffer) {
            let sum = 0;

            for (let i = 0; i < buffer.length; i++) {
                sum += buffer[i] * buffer[i];
            }

            return Math.sqrt(sum / buffer.length);
        }
    </script>
</body>
</html>
