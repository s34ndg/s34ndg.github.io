<!DOCTYPE html>
<html>
<head>
    <title>Audio Detection Web App</title>
    <script>
    let ambientNoiseLevel = 0; // Ambient noise level in dB
    let threshold = 60; // Audio threshold in dB
    let silenceDuration = 5; // Silence duration in seconds
    let isListening = false;
    let silenceTimer = null;

   // Function to measure ambient noise level
function measureAmbientNoiseLevel() {
  // Use the getUserMedia API to access audio input from the user's device
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then((stream) => {
      const audioContext = new AudioContext();
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      source.connect(analyser);

      // Start capturing audio data and calculate the average noise level
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      let total = 0;
      let count = 0;

      const calculateAverageNoiseLevel = () => {
        analyser.getByteFrequencyData(dataArray);
        const sum = dataArray.reduce((acc, value) => acc + value, 0);
        const average = sum / bufferLength;
        total += average;
        count++;

        if (count === 10) { // Adjust the number of iterations as needed
          // Calculate the average ambient noise level
          ambientNoiseLevel = Math.floor(total / count);
          document.getElementById('ambientNoiseLevel').textContent = ambientNoiseLevel + ' dB';
          console.log('Ambient noise level calibrated:', ambientNoiseLevel);

          // Stop capturing audio and release resources
          stream.getTracks().forEach(track => track.stop());
        } else {
          setTimeout(calculateAverageNoiseLevel, 100); // Adjust the interval as needed
        }
      };

      calculateAverageNoiseLevel();
    })
    .catch((error) => {
      console.error('Failed to access audio input:', error);
    });
}

// Function to start listening for silence
function startListening() {
  // Add your custom audio detection logic here
  // You would typically use the Web Audio API or another audio processing library

  // Example placeholder code for detecting silence
  setInterval(() => {
    // Check if the detected audio level is below the threshold
    if (detectAudioLevel() < threshold) {
      // Silence detected, show browser notification
      const notification = new Notification('No Audio Detected', {
        body: 'Please speak louder than the ambient noise level.',
      });
      notification.onclick = () => {
        // Handle notification click event
        // You can perform any desired action here
        console.log('Notification clicked');
      };
    }
  }, silenceDuration * 1000); // Convert silence duration to milliseconds

  console.log('Listening for silence...');
}

function detectAudioLevel() {
  // Create an AudioContext
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();

  // Create a MediaStreamSource from the user's microphone
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function(stream) {
      const source = audioContext.createMediaStreamSource(stream);

      // Create a ScriptProcessorNode to process the audio data
      const scriptNode = audioContext.createScriptProcessor(4096, 1, 1);
      scriptNode.onaudioprocess = function(event) {
        const inputBuffer = event.inputBuffer;
        const inputData = inputBuffer.getChannelData(0);

        // Calculate the average absolute audio level
        let sum = 0;
        for (let i = 0; i < inputData.length; i++) {
          sum += Math.abs(inputData[i]);
        }
        const average = sum / inputData.length;

        // Call a function or perform any desired action with the audio level
        handleAudioLevel(average);
      };

      // Connect the audio source to the script node
      source.connect(scriptNode);
      scriptNode.connect(audioContext.destination);
    })
    .catch(function(err) {
      console.error('Error accessing microphone:', err);
    });
}

// Function to handle the audio level (replace with your desired action)
function handleAudioLevel(level) {
  console.log('Audio Level:', level);
}


    // Function to stop listening for silence
    function stopListening() {
      isListening = false;
      document.getElementById('stopButton').style.display = 'none';
      document.getElementById('startButton').style.display = 'block';

      // Reset silence timer
      clearTimeout(silenceTimer);

      console.log('Listening stopped.');
    }

    // Function to update the threshold value
    function updateThreshold() {
      threshold = parseInt(document.getElementById('thresholdInput').value);
      document.getElementById('thresholdValue').textContent = threshold + ' dB';
      console.log('Threshold updated:', threshold);
    }

    // Function to update the silence duration
    function updateSilenceDuration() {
      silenceDuration = parseInt(document.getElementById('silenceDurationInput').value);
      console.log('Silence duration updated:', silenceDuration);
    }
  </script>
</head>
<body>
<h1>Audio Detection Web App</h1>
<h3>Ambient Noise Calibration</h3>
<button onclick="measureAmbientNoiseLevel()">Calibrate Ambient Noise</button>
<p>Ambient Noise Level: <span id="ambientNoiseLevel">-</span> dB</p>

<h3>Audio Detection Settings</h3>
<label for="thresholdInput">Threshold: </label>
<input type="number" id="thresholdInput" value="60">
<button onclick="updateThreshold()">Update Threshold</button>
<p>Threshold Value: <span id="thresholdValue">60 dB</span></p>

<label for="silenceDurationInput">Silence Duration (in seconds): </label>
<input type="number" id="silenceDurationInput" value="5">
<button onclick="updateSilenceDuration()">Update Silence Duration</button>

<h3>Audio Detection</h3>
<button id="startButton" onclick="startListening()">Start Listening for Silence</button>
<button id="stopButton" onclick="stopListening()" style="display: none;">Stop Listening</button>

<script>
    // Request permission for notifications
    Notification.requestPermission().then((permission) => {
      console.log('Notification permission:', permission);
    });
  </script>

<footer>version 0.0.21</footer>

</body>
</html>
