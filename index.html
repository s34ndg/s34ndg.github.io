<!DOCTYPE html>
<html>
<head>
    <title>Audio Silence Detection</title>
    <script src="audio-worklet.js" type="module"></script>
</head>
<body>
    <h1>Audio Silence Detection</h1>
    <div>
        <button id="startButton">Start Listening</button>
        <button id="stopButton" style="display: none;">Stop Listening</button>
    </div>
    <div>
        <label for="thresholdInput">Threshold:</label>
        <input type="number" id="thresholdInput" value="-30" step="0.1">
        <span id="thresholdValue">-30 dB</span>
    </div>
    <div>
        <label for="silenceDurationInput">Silence Duration (seconds):</label>
        <input type="number" id="silenceDurationInput" value="3" step="1">
    </div>
    <div>
        <h3>Audio Level:</h3>
        <span id="currentAudioLevel">0 dB</span>
    </div>
    <div>
        <h3>Audio Indicator:</h3>
        <span id="audioIndicator">Not Listening</span>
    </div>

    <script>
        let audioContext;
        let isListening = false;
        let silenceTimer;
        let silenceDuration = 3;
        let threshold = -30;
        let notification;

        document.getElementById('startButton').addEventListener('click', startListening);
        document.getElementById('stopButton').addEventListener('click', stopListening);
        document.getElementById('thresholdInput').addEventListener('input', updateThreshold);
        document.getElementById('silenceDurationInput').addEventListener('input', updateSilenceDuration);

        function startListening() {
            isListening = true;
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('stopButton').style.display = 'block';
            document.getElementById('audioIndicator').textContent = 'Listening...';

            // Request microphone access
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    // Create audio context
                    audioContext = new AudioContext();

                    // Register audio worklet
                    audioContext.audioWorklet.addModule('audio-worklet.js')
                        .then(function () {
                            const audioSource = audioContext.createMediaStreamSource(stream);
                            const audioWorkletNode = new AudioWorkletNode(audioContext, 'silence-detector');
                            audioSource.connect(audioWorkletNode);
                            audioWorkletNode.connect(audioContext.destination);
                        })
                        .catch(function (err) {
                            console.error('Error registering audio worklet:', err);
                        });
                })
                .catch(function (err) {
                    console.error('Error accessing microphone:', err);
                });
        }

        function startSilenceTimer() {
            // Clear any existing silence timer
            clearTimeout(silenceTimer);

            // Start a new silence timer
            silenceTimer = setTimeout(() => {
                if (Notification.permission === 'granted') {
                    notification = new Notification('Silence Detected', {
                        body: 'No audio detected for the specified duration.',
                    });
                    notification.onclick = () => {
                        console.log('Notification clicked');
                    };
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then((permission) => {
                        if (permission === 'granted') {
                            notification = new Notification('Silence Detected', {
                                body: 'No audio detected for the specified duration.',
                            });
                            notification.onclick = () => {
                                console.log('Notification clicked');
                            };
                        }
                    });
                }
                silenceTimer = null;
            }, silenceDuration * 1000);
        }

        function stopListening() {
            isListening = false;
            document.getElementById('stopButton').style.display = 'none';
            document.getElementById('startButton').style.display = 'block';
            document.getElementById('audioIndicator').textContent = 'Not Listening';

            // Reset silence timer
            clearTimeout(silenceTimer);
            silenceTimer = null;

            // Close notification if it exists
            if (notification) {
                notification.close();
                notification = null;
            }

            // Release resources
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            console.log('Listening stopped.');
        }

        function updateThreshold() {
            threshold = parseFloat(document.getElementById('thresholdInput').value);
            document.getElementById('thresholdValue').textContent = threshold.toFixed(1) + ' dB';
            console.log('Threshold updated:', threshold);
        }

        function updateSilenceDuration() {
            silenceDuration = parseInt(document.getElementById('silenceDurationInput').value);
            console.log('Silence duration updated:', silenceDuration);
        }

        // Request permission for notifications upon button click
        function requestNotificationPermission() {
            if (Notification.permission === 'granted') {
                console.log('Notification permission already granted');
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then((permission) => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                    }
                });
            }
        }

        requestNotificationPermission(); // Request permission on page load
    </script>
    <footer>version 0.88</footer>
</body>
</html>
